\begingroup\endlinechar=-1\catcode"09=\catcode0\relax%<TAB>,9,'011"09
\expandafter\newcount\csname mathexp count\endcsname
\global\csname mathexp count\endcsname=0\relax
%
\expandafter\gdef\csname mathexp ft\endcsname{\csname ui\endcsname}
%NOTE: 这里的 \ui 字体来源于我个人自用的字体配置文件。未加载时这里会是 \relax
% cannot define in \markexp because this format is not always used immediately
%
\gdef\markexp#1{
\expandafter\ifx\csname mathexp marked #1\endcsname\relax
\csname mark new exp\endcsname{#1}
\else
\csname mathexp marked #1\endcsname
\fi
}
\expandafter\gdef\csname mark new exp\endcsname#1{
\ifmmode\else\errmessage{[\string\markexp] cannot mark a new exp outside math mode}\fi
\global\advance\csname mathexp count\endcsname by 1
\hbox to 0ex{
	\qquad
	{\csname mathexp ft\endcsname(\the\csname mathexp count\endcsname)}
	\hss
}
\expandafter\xdef\csname mathexp marked #1 count\endcsname{\the\csname mathexp count\endcsname}
\expandafter\gdef\csname mathexp marked #1\endcsname{
	{\csname mathexp ft\endcsname(\csname mathexp marked #1 count\endcsname)}
}
}

\expandafter\newbox\csname math lr box\endcsname
\gdef\(#1{% better \left
\expandafter\def\csname math left\endcsname{\csname math left right\endcsname#1}
\begingroup
\setbox\csname math lr box\endcsname=\hbox\bgroup
\expandafter\aftergroup\csname math left\endcsname
}
\gdef\)#1{% better \right
\egroup
#1
\endgroup
}
\expandafter\gdef\csname math left right\endcsname#1#2{{
\dimen0=\ht\csname math lr box\endcsname
\dimen1=1em\advance\dimen1 by2\jot % up jot and down jot
\divide\dimen0 by\dimen1
\count0=\dimen0 % l=<line count> \count0==(2l-1), etc 1,3,5,7,9,...
\advance\count0 by 1\divide\count0 by 2 % line count of \box0
\advance\count0 by -1 % \left \right work fine for only 1 line
\dimen2=1em\advance\dimen2 by2\jot\multiply\dimen2 by\count0
\dimen1=\ht\csname math lr box\endcsname\advance\dimen1 by-\dimen2
\dimen0=\ht\csname math lr box\endcsname
\left#1\vbox to\dimen1{\box\csname math lr box\endcsname\vss}\right#2
}}

\endgroup%
